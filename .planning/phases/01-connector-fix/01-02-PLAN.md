---
phase: 01-connector-fix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - role-map-app/src/components/RoleMapCanvas.tsx
  - role-map-app/src/App.css
autonomous: true

must_haves:
  truths:
    - "User sees visual highlight on valid target handles while dragging connector"
    - "Handles become visible and highlighted when connection drag starts"
    - "Visual feedback disappears when connection drag ends"
  artifacts:
    - path: "role-map-app/src/components/RoleMapCanvas.tsx"
      provides: "Connection state tracking for visual feedback"
      contains: "onConnectStart|onConnectEnd|isConnecting"
    - path: "role-map-app/src/App.css"
      provides: "Handle highlight styles during connection"
      contains: "connecting.*handle|handle.*highlight"
  key_links:
    - from: "ReactFlow.onConnectStart"
      to: "CSS class application"
      via: "state toggle"
      pattern: "setIsConnecting|connecting"
    - from: "connecting state"
      to: "handle visibility"
      via: "CSS class on canvas container"
      pattern: "canvas-container.*connecting"
---

<objective>
Add visual feedback when dragging connectors to show valid connection targets.

Purpose: Users need to see which handles they can connect to while dragging. Without this, the connection experience feels blind and frustrating.

Output: Handles become visible and highlighted on all nodes when user starts dragging a connector, providing clear visual guidance.
</objective>

<execution_context>
@/home/codespace/.claude/get-shit-done/workflows/execute-plan.md
@/home/codespace/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md

Key files:
@role-map-app/src/components/RoleMapCanvas.tsx
@role-map-app/src/App.css
@role-map-app/src/components/RoleNode.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add connection state tracking</name>
  <files>role-map-app/src/components/RoleMapCanvas.tsx</files>
  <action>
Add state to track when a connection is being dragged:

1. Add a new state variable near the other state declarations (around line 88):
```typescript
const [isConnecting, setIsConnecting] = useState(false);
```

2. Add onConnectStart callback (after onReconnectStart, around line 620):
```typescript
const onConnectStart = useCallback(() => {
  setIsConnecting(true);
}, []);
```

3. Add onConnectEnd callback:
```typescript
const onConnectEnd = useCallback(() => {
  setIsConnecting(false);
}, []);
```

4. Pass these to ReactFlow component (around line 696-729):
```typescript
onConnectStart={onConnectStart}
onConnectEnd={onConnectEnd}
```

5. Add a CSS class to the canvas container when connecting (line 695):
```typescript
<div className={`canvas-container ${isConnecting ? 'connecting' : ''}`} ref={flowRef}>
```

This creates the foundation for CSS-based visual feedback.
  </action>
  <verify>
1. `npm run build` passes
2. Run dev server
3. Start dragging from a handle - inspect the canvas-container element in dev tools
4. It should have the "connecting" class while dragging
5. Class should be removed when drag ends (release or connect)
  </verify>
  <done>
Canvas container gets "connecting" class during connection drag, removed when drag ends.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CSS styles for handle highlighting</name>
  <files>role-map-app/src/App.css</files>
  <action>
Add CSS rules to highlight handles during connection:

1. Find the existing handle styles (around lines 660-684). After those, add:

```css
/* Handle highlighting during connection drag */
.canvas-container.connecting .react-flow__handle {
  opacity: 1 !important;
  transform: scale(1.5);
  transition: all 0.15s ease;
}

.canvas-container.connecting .react-flow__handle::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 20px;
  height: 20px;
  border: 2px solid currentColor;
  border-radius: 50%;
  opacity: 0.5;
  animation: pulse-handle 1s ease-in-out infinite;
}

@keyframes pulse-handle {
  0%, 100% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 0.5;
  }
  50% {
    transform: translate(-50%, -50%) scale(1.3);
    opacity: 0.2;
  }
}

/* Highlight valid drop targets more prominently */
.canvas-container.connecting .react-flow__handle.connectingto,
.canvas-container.connecting .react-flow__handle.connectingfrom {
  background: #22c55e !important;
  transform: scale(2);
}

.canvas-container.connecting .react-flow__handle.connectingto::after,
.canvas-container.connecting .react-flow__handle.connectingfrom::after {
  border-color: #22c55e;
  animation: none;
  opacity: 0.8;
}
```

2. This creates:
   - All handles become visible and slightly larger when connecting
   - A subtle pulse animation draws attention to valid targets
   - The handle being hovered gets extra prominent green highlighting
  </action>
  <verify>
1. Start dragging from any handle
2. ALL handles on ALL nodes should become visible (not just hovered node)
3. Handles should pulse subtly
4. Hovering over a target handle should make it turn green and grow larger
5. Releasing the drag should return handles to normal (invisible until hover)
  </verify>
  <done>
Handles show clear visual feedback during connection: all become visible with pulse animation, hovered targets highlight in green.
  </done>
</task>

<task type="auto">
  <name>Task 3: Polish and test the visual feedback</name>
  <files>role-map-app/src/App.css</files>
  <action>
Fine-tune the visual feedback for better UX:

1. Ensure the connection line itself is visible. Add to App.css if needed:
```css
/* Connection line styling */
.react-flow__connection-line {
  stroke: #2d3e50;
  stroke-width: 2;
}

.canvas-container.connecting .react-flow__connection-line {
  stroke: #22c55e;
  stroke-width: 3;
}
```

2. Add a subtle cursor change while connecting:
```css
.canvas-container.connecting {
  cursor: crosshair;
}

.canvas-container.connecting .react-flow__handle {
  cursor: pointer;
}
```

3. Test the complete flow:
   - Drag from handle -> all handles visible, cursor changes
   - Move over different nodes -> handles pulse
   - Hover specific handle -> turns green
   - Connect to handle -> feedback disappears, edge created
   - Cancel drag (release on empty space) -> feedback disappears

4. Ensure no performance issues (jank) during connection by checking:
   - CSS transitions are GPU-accelerated (transform, opacity)
   - No excessive re-renders (React DevTools profiler)
  </action>
  <verify>
1. Complete connection flow feels smooth and responsive
2. Visual cues are clear without being distracting
3. No flickering or lag during drag
4. Works correctly with zoom in/out
5. Works correctly when connecting to nodes in different sections
  </verify>
  <done>
Visual feedback is polished: smooth animations, clear affordances, no performance issues.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. Start dragging connector - immediate visual feedback (handles visible everywhere)
2. Move mouse around canvas - handles pulse to show they're valid targets
3. Hover over specific handle - prominent green highlight
4. Complete connection - feedback disappears, edge connects correctly
5. Cancel connection - feedback disappears cleanly
6. Test with multiple sections open
7. Test at different zoom levels
</verification>

<success_criteria>
- All handles become visible when user starts dragging a connector
- Clear visual distinction between available handles and the one being targeted
- Smooth animations without performance issues
- Visual feedback clears immediately when connection completes or cancels
- Works correctly across different zoom levels and viewport positions
</success_criteria>

<output>
After completion, create `.planning/phases/01-connector-fix/01-02-SUMMARY.md`
</output>
