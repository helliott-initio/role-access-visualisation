---
phase: 01-connector-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - role-map-app/src/components/RoleMapCanvas.tsx
  - role-map-app/src/hooks/useRoleMap.ts
autonomous: true

must_haves:
  truths:
    - "User drags from bottom handle of node A to top handle of node B -> edge connects bottom-to-top (not snap to defaults)"
    - "User reconnects existing edge to different handle -> edge position updates immediately"
    - "Edge handle positions persist across browser reload"
    - "Edge positions survive section collapse/expand without snapping to wrong handles"
  artifacts:
    - path: "role-map-app/src/components/RoleMapCanvas.tsx"
      provides: "Edge building with explicit handle IDs"
      contains: "sourceHandle.*targetHandle"
    - path: "role-map-app/src/hooks/useRoleMap.ts"
      provides: "Handle persistence in reparentGroup"
      contains: "sourceHandle.*targetHandle"
  key_links:
    - from: "RoleMapCanvas.onConnect"
      to: "reparentGroup"
      via: "handle ID parameters"
      pattern: "onReparent.*sourceHandle.*targetHandle"
    - from: "reparentGroup"
      to: "localStorage"
      via: "setState with handle fields"
      pattern: "sourceHandle.*targetHandle"
    - from: "builtEdges"
      to: "Edge.sourceHandle/targetHandle"
      via: "map data -> edge props"
      pattern: "sourceHandle.*group\\.sourceHandle"
---

<objective>
Fix edge handle persistence so connectors attach to the exact handles the user drags to.

Purpose: Currently edges snap to default positions instead of the specific handle the user selected. This breaks the core value proposition of "connectors go where you drag them."

Output: Edges connect to and stay at the exact handles selected, persisting through reload and collapse/expand cycles.
</objective>

<execution_context>
@/home/codespace/.claude/get-shit-done/workflows/execute-plan.md
@/home/codespace/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md

Key files:
@role-map-app/src/components/RoleMapCanvas.tsx
@role-map-app/src/hooks/useRoleMap.ts
@role-map-app/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix edge building to use stored handle IDs</name>
  <files>role-map-app/src/components/RoleMapCanvas.tsx</files>
  <action>
In RoleMapCanvas.tsx, the `builtEdges` construction (around line 169-189) creates edges with:
```typescript
sourceHandle: group.sourceHandle || undefined,
targetHandle: group.targetHandle || undefined,
```

This looks correct, but there's a subtle issue: React Flow may ignore `undefined` and use defaults. The fix:

1. In the builtEdges useMemo (lines 163-190), change the edge creation to ONLY include sourceHandle/targetHandle when they have actual values (not just truthy check). Use explicit null check:
```typescript
...(group.sourceHandle ? { sourceHandle: group.sourceHandle } : {}),
...(group.targetHandle ? { targetHandle: group.targetHandle } : {}),
```

2. Verify the onConnect handler (around line 651-682) is correctly extracting and passing handle IDs. The current code looks correct but double-check that `connection.sourceHandle` and `connection.targetHandle` are being passed to `onReparent`.

3. Verify the onReconnect handler (around line 622-636) passes handle IDs correctly. Same verification.

4. After making changes, add a console.log in onConnect to verify handles are being captured:
```typescript
console.log('Connect:', { source: connection.source, target: connection.target, sourceHandle: connection.sourceHandle, targetHandle: connection.targetHandle });
```
Remove this log after verification.
  </action>
  <verify>
1. `npm run build` passes with no TypeScript errors
2. Run the dev server: `npm run dev`
3. Create a new edge by dragging from the BOTTOM handle of one node to the TOP handle of another
4. Check browser console for the logged handle values (should show "bottom" and "top")
5. The edge should visually connect bottom-to-top
  </verify>
  <done>
New edges are created with the exact handles the user dragged to, visible in both the edge rendering and the console log.
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure handle IDs persist through reload</name>
  <files>role-map-app/src/hooks/useRoleMap.ts</files>
  <action>
The reparentGroup function (lines 186-211) already stores sourceHandle and targetHandle. However, verify the entire persistence chain:

1. In useRoleMap.ts, verify reparentGroup correctly spreads handle values:
```typescript
sourceHandle: newParentId ? sourceHandle : undefined,
targetHandle: newParentId ? targetHandle : undefined,
```
This clears handles when parent is removed, which is correct.

2. Verify the localStorage persistence in the useEffect (lines 27-30) serializes the full state including handles. This should work automatically since it stringifies `state.maps`.

3. Add temporary logging to verify persistence:
- In reparentGroup, log: `console.log('Reparent:', { childId, newParentId, sourceHandle, targetHandle });`
- This confirms handles reach the state management layer

4. Test: Create an edge, reload the page, and verify:
- The edge still connects to the correct handles
- Check localStorage in dev tools: `localStorage.getItem('role-map-data')` should show sourceHandle/targetHandle in the group data
  </action>
  <verify>
1. Create edge from bottom handle to top handle
2. Refresh the browser
3. Edge should still connect bottom-to-top (not default positions)
4. Check localStorage: `JSON.parse(localStorage.getItem('role-map-data')).maps[0].groups` should show sourceHandle/targetHandle values
  </verify>
  <done>
Handle positions survive browser reload with correct values persisted in localStorage.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test and verify collapse/expand preserves handles</name>
  <files>role-map-app/src/components/RoleMapCanvas.tsx</files>
  <action>
Section collapse/expand causes nodes to be removed and re-added to the canvas. Verify handles survive this cycle:

1. The position cache (positionCacheRef) preserves node positions. Handles are stored in the data model (map.groups), not React Flow state, so they should persist.

2. In the useEffect that syncs builtNodes/builtEdges (lines 236-274), verify that when nodes are re-added after expand, the edges are rebuilt from builtEdges which reads from map.groups (which has handle data).

3. Test the collapse/expand cycle:
   - Create an edge with specific handles (bottom-to-left)
   - Collapse the section containing one of the nodes
   - Expand the section
   - Verify the edge still connects to the correct handles

4. If handles are lost, the issue is in builtEdges construction. The fix would be ensuring builtEdges always reads current group.sourceHandle/targetHandle values.

5. Remove any debug console.logs added in previous tasks.
  </action>
  <verify>
1. Create edge from bottom handle to left handle
2. Collapse section containing the target node
3. Expand section
4. Edge should reconnect to the same handles (bottom to left)
5. No console errors about missing handles or edge connection issues
  </verify>
  <done>
Edge handle positions survive section collapse/expand cycles without snapping to default positions.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. Create multiple edges with different handle combinations:
   - bottom -> top
   - left -> right
   - right -> bottom
2. Reload browser - all edges maintain their handle positions
3. Collapse/expand sections - edges maintain positions
4. Reconnect an edge to a different handle - new position is saved and persists
5. No TypeScript errors, no console warnings about edge connections
</verification>

<success_criteria>
- User can drag connector from any handle and it connects to the exact target handle
- Handle positions persist across page reload
- Handle positions survive section collapse/expand
- Reconnecting edges to different handles updates and persists correctly
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-connector-fix/01-01-SUMMARY.md`
</output>
